<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Cargas (Tracking ‚Üí Producto ‚Üí Foto)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121a24;
      --muted:#8aa0b6;
      --text:#e9f0f7;
      --line:#203042;
      --ok:#23c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --wa:#25D366;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(37,211,102,.10), transparent 55%),
                  radial-gradient(1200px 700px at 85% 20%, rgba(59,130,246,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    header{
      display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
      gap:12px; padding:8px 0 16px;
    }
    .title{ display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .title h1{ margin:0; font-size: clamp(18px, 2.2vw, 28px); letter-spacing:.2px; }
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      white-space: nowrap;
    }

    .grid{ display:grid; grid-template-columns: 1.05fr .95fr; gap:14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      flex-wrap:wrap;
    }
    .card .hd h2{ margin:0; font-size: 15px; letter-spacing:.2px; }
    .card .bd{ padding: 14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .row > *{ flex:1; min-width: 180px; }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
    }
    input:focus{
      border-color: rgba(37,211,102,.55);
      box-shadow: 0 0 0 4px rgba(37,211,102,.10);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing: .2px;
    }

    .btns{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 10px; }
    button{
      cursor:pointer;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 650;
      letter-spacing: .2px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      min-height: 42px;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    button:active{ transform: translateY(1px); }
    button.secondary{ background: rgba(255,255,255,.02); }
    button.wa{
      border-color: rgba(37,211,102,.45);
      background: linear-gradient(180deg, rgba(37,211,102,.16), rgba(37,211,102,.08));
    }
    button.danger{
      border-color: rgba(239,68,68,.45);
      background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.08));
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .videoBox{
      position: relative;
      width: 100%;
      aspect-ratio: 16/10;
      background: #05070a;
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      overflow:hidden;
    }
    /* SIN ESPEJO */
    .videoBox video{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform:none;
    }

    .overlay{
      pointer-events:none;
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .scanFrame{
      width: 78%;
      height: 22%;
      border-radius: 14px;
      border: 2px solid rgba(37,211,102,.85);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
      position:relative;
    }
    .scanHint{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -34px;
      font-size: 12px;
      color: rgba(233,240,247,.85);
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.08);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    /* Frame alternativo (franja superior) */
    .scanFrameTop{
      width: 86%;
      height: 18%;
      border-radius: 14px;
      border: 2px solid rgba(59,130,246,.85);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
      position:absolute;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      display:none;
    }
    .scanFrameTop.show{ display:block; }
    .scanFrameTop .scanHint{
      bottom: -34px;
    }

    .status{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(245,158,11,.9);
      box-shadow: 0 0 0 4px rgba(245,158,11,.12);
    }
    .dot.ok{ background: rgba(35,197,94,.95); box-shadow: 0 0 0 4px rgba(35,197,94,.12); }
    .dot.bad{ background: rgba(239,68,68,.95); box-shadow: 0 0 0 4px rgba(239,68,68,.12); }

    .hint{
      margin-top:10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    /* OCR preview */
    .ocrBox{
      margin-top: 10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 10px;
      background: rgba(0,0,0,.14);
      display:none;
      gap:10px;
    }
    .ocrBox.show{ display:grid; grid-template-columns: 120px 1fr; }
    .ocrBox img{
      width:120px; height:120px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      object-fit: cover;
      background:#000;
    }
    .ocrSmall{ font-size:12px; color: var(--muted); margin-top:6px; }
    .ocrStrong{ font-weight:800; font-size:13px; word-break:break-all; }

    .items{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      overflow:hidden;
      display:grid;
      grid-template-columns: 92px 1fr;
      gap: 10px;
      padding: 10px;
    }
    .thumb{
      width: 92px; height: 92px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .thumb img{ width:100%; height:100%; object-fit: cover; display:block; }
    .noimg{ font-size: 11px; color: rgba(138,160,182,.95); text-align:center; padding: 0 8px; }

    .meta{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .metaTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .meta strong{ font-size: 14px; line-height: 1.25; display:block; word-break: break-word; }
    .meta small{ color: var(--muted); display:block; font-size: 12px; }

    .miniBtns{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .miniBtns button{ min-height: 34px; padding: 7px 10px; border-radius: 12px; font-weight: 700; font-size: 12px; }

    .totals{
      display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;
      align-items:center; justify-content:space-between;
      border-top: 1px dashed rgba(255,255,255,.10);
      padding-top: 10px;
      color: rgba(233,240,247,.92);
    }
    .totals .big{ font-size: 16px; font-weight: 800; }
    .totals .muted{ color: var(--muted); font-size: 12px; }

    .historyList{ display:flex; flex-direction:column; gap:10px; }
    .historyItem{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(0,0,0,.14);
    }
    .historyItem .top{
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .historyItem .top strong{ font-size: 13px; word-break: break-word; }
    .historyItem .top small{ display:block; font-size: 12px; color: var(--muted); margin-top: 4px; }
    .historyItem .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .historyItem .actions button{ min-height: 34px; padding: 7px 10px; border-radius: 12px; font-size: 12px; }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 12px;
      color: rgba(233,240,247,.9);
      white-space: nowrap;
    }

    .toggleRow{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
    }
    .switch{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:6px 10px;
      border-radius: 999px;
      user-select:none;
    }
    .switch input{ width:auto; margin:0; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Registro de Cargas (Tracking ‚Üí Producto ‚Üí Foto)</h1>
        <span class="pill">M√≥vil/PC ¬∑ OCR inteligente (8+ d√≠gitos) ¬∑ Sin espejo</span>
      </div>
      <div class="status">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Listo. Inicia c√°mara y usa OCR para capturar el tracking.</span>
      </div>
    </header>

    <div class="grid">
      <!-- CARGA ACTUAL -->
      <section class="card">
        <div class="hd">
          <h2>Carga actual</h2>
          <div class="btns" style="margin:0">
            <button class="secondary" id="btnNewLoad">Nueva carga</button>
            <button class="danger" id="btnClearAll">Borrar historial</button>
          </div>
        </div>

        <div class="bd">
          <div class="row">
            <div>
              <label>Tracking (se llena por OCR/esc√°ner, pero puedes editar)</label>
              <input id="trackingInput" class="mono" placeholder="Ej: 4203316660949402108106245672088267" autocomplete="off" />
            </div>
            <div>
              <label>Fecha/Hora</label>
              <input id="dateInput" class="mono" readonly />
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="videoBox">
              <video id="video" playsinline muted></video>

              <div class="overlay">
                <!-- ROI centro -->
                <div class="scanFrame" id="roiCenter">
                  <div class="scanHint">Alinea el tracking dentro del recuadro</div>
                </div>
              </div>

              <!-- ROI franja superior (mejor para etiquetas con "Tracking:") -->
              <div class="scanFrameTop" id="roiTop">
                <div class="scanHint">Modo superior: enfoca la l√≠nea ‚ÄúTracking: 123...‚Äù</div>
              </div>
            </div>

            <div class="toggleRow">
              <span class="switch">
                <input type="checkbox" id="chkTopRoi" />
                <label for="chkTopRoi">OCR en franja superior</label>
              </span>
              <span>Act√≠valo si tu etiqueta tiene ‚ÄúTracking:‚Äù arriba (mejora precisi√≥n).</span>
            </div>

            <div class="btns">
              <button id="btnStartCam">Iniciar c√°mara</button>
              <button class="secondary" id="btnStopCam" disabled>Detener</button>
              <button class="secondary" id="btnSwitchCam">Cambiar c√°mara</button>
              <button class="secondary" id="btnTorch" style="display:none;">Linterna</button>

              <button class="secondary" id="btnBarcode" disabled>Escanear c√≥digo (QR/Barra)</button>
              <button class="secondary" id="btnOcrView" disabled>OCR del recuadro (Tracking)</button>
              <button class="secondary" id="btnOcrImage">OCR desde foto</button>
            </div>

            <!-- Zoom (si existe) -->
            <div id="zoomWrap" style="display:none; margin-top:10px;">
              <label>Zoom (si tu c√°mara lo soporta)</label>
              <input id="zoomRange" type="range" min="1" max="1" step="0.1" value="1" />
              <div class="ocrSmall">S√∫bele un poco el zoom para que el n√∫mero salga m√°s n√≠tido.</div>
            </div>

            <!-- OCR preview -->
            <div class="ocrBox" id="ocrBox">
              <img id="ocrImg" alt="OCR preview" />
              <div>
                <div class="ocrStrong">Tracking detectado:</div>
                <div class="ocrStrong" id="ocrDetected">‚Äî</div>
                <div class="ocrSmall" id="ocrTip">
                  Tip: acerca la c√°mara, buena luz, evita reflejos. Si sale fecha, activa ‚Äúfranja superior‚Äù.
                </div>
              </div>
            </div>

            <div class="hint">
              üìå Si tu tracking es texto (n√∫meros impresos), usa <span class="kbd">OCR del recuadro</span>.
              <br/>‚úÖ Mejor: activa <span class="kbd">OCR en franja superior</span> cuando tu etiqueta diga ‚ÄúTracking:‚Äù.
            </div>

            <input id="fileInputOcr" type="file" accept="image/*" style="display:none;" />
          </div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.08); margin:14px 0;"/>

          <h3 style="margin:0 0 10px; font-size:14px;">Agregar producto (Informaci√≥n + Foto)</h3>

          <div class="row">
            <div>
              <label>Producto</label>
              <input id="productInput" placeholder="Ej: pares de zapatos Nike" />
            </div>
            <div>
              <label>Unidades</label>
              <input id="qtyInput" type="number" min="1" step="1" placeholder="Ej: 3" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Foto (c√°mara o subir)</label>
              <div class="btns" style="margin-top:0">
                <button id="btnTakePhoto">Tomar foto</button>
                <button class="secondary" id="btnUploadPhoto">Subir foto</button>
                <button class="secondary" id="btnRemovePendingPhoto" disabled>Quitar foto</button>
              </div>

              <!-- capture=environment abre c√°mara en m√≥vil -->
              <input id="fileInputPhotoCam" type="file" accept="image/*" capture="environment" style="display:none;" />
              <input id="fileInputPhoto" type="file" accept="image/*" style="display:none;" />

              <div id="pendingPhotoWrap" style="display:none; margin-top:10px;">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <div class="thumb" style="width:120px; height:120px;">
                    <img id="pendingPhotoImg" alt="Foto pendiente" />
                  </div>
                  <div style="flex:1; min-width: 180px;">
                    <div style="font-weight:800;">Foto lista ‚úÖ</div>
                    <div class="hint" style="margin-top:6px;">
                      Se guardar√° junto con el producto al presionar <span class="kbd">Agregar a la carga</span>.
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="btns" style="margin-top:12px;">
            <button id="btnAddItem">Agregar a la carga</button>
          </div>

          <div class="totals">
            <div>
              <div class="big">Total unidades: <span id="totalUnits">0</span></div>
              <div class="muted">Productos agregados: <span id="totalItems">0</span></div>
            </div>

            <div class="btns" style="margin:0">
              <button class="wa" id="btnSendWhatsApp">Enviar carga registrada (texto)</button>
              <button class="secondary" id="btnShareOrdered">Compartir en orden (texto+foto)</button>
            </div>
          </div>

          <div class="hint">
            ‚Ä¢ ‚ÄúEnviar‚Äù manda el texto a WhatsApp (eliges el chat).<br/>
            ‚Ä¢ ‚ÄúCompartir en orden‚Äù intenta mandar 1 producto + su foto uno por uno (seg√∫n soporte del m√≥vil).
          </div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.08); margin:14px 0;"/>

          <h3 style="margin:0 0 10px; font-size:14px;">Listado (Informaci√≥n + Foto, en orden)</h3>
          <div class="items" id="itemsList"></div>
        </div>
      </section>

      <!-- HISTORIAL -->
      <section class="card">
        <div class="hd">
          <h2>Historial de cargas</h2>
          <button class="secondary" id="btnExportJson">Exportar JSON</button>
        </div>
        <div class="bd">
          <div class="historyList" id="historyList"></div>
          <div class="hint" style="margin-top:12px;">
            Se guarda en tu navegador (localStorage).
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Tesseract OCR (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    /********************
     * Helpers
     ********************/
    const $ = (id)=>document.getElementById(id);

    function setStatus(type, text){
      const dot = $("statusDot");
      dot.classList.remove("ok","bad");
      if(type==="ok") dot.classList.add("ok");
      if(type==="bad") dot.classList.add("bad");
      $("statusText").textContent = text;
    }

    function nowStamp(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function sanitizeTracking(raw){
      if(!raw) return "";
      return String(raw).trim().replace(/\s+/g," ").slice(0, 200);
    }

    function beep(){
      try{
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if(!AudioCtx) return;
        const ctx = new AudioCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.05;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 110);
      }catch(e){}
      if(navigator.vibrate) navigator.vibrate(80);
    }

    function formatWhatsAppText(load){
      const lines = [];
      lines.push("üì¶ Carga registrada");
      lines.push(`Tracking: ${load.tracking || "(sin tracking)"}`);
      lines.push(`Fecha: ${load.date}`);
      lines.push("");
      load.items.forEach((it, idx)=>{
        lines.push(`${idx+1}) ${it.qty} / ${it.product}`);
        lines.push(it.photo ? `   üñºÔ∏è Foto: ${idx+1}` : `   üñºÔ∏è Foto: (no adjunta)`);
        lines.push("");
      });
      const totalUnits = load.items.reduce((a,b)=>a + (Number(b.qty)||0), 0);
      lines.push(`‚úÖ Total unidades: ${totalUnits}`);
      lines.push(`üßæ Total productos: ${load.items.length}`);
      return lines.join("\n").trim();
    }

    function dataUrlToBlob(dataUrl){
      return fetch(dataUrl).then(r=>r.blob());
    }

    /********************
     * Storage
     ********************/
    const STORAGE_KEY = "registro_cargas_v4_full";
    function loadStore(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"history":[]}'); }
      catch(e){ return {history:[]}; }
    }
    function saveStore(store){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }

    let store = loadStore();

    let currentLoad = {
      id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()),
      date: nowStamp(),
      tracking: "",
      items: []
    };

    function persistCurrentToHistory(){
      if(!currentLoad.tracking && currentLoad.items.length===0) return;
      const idx = store.history.findIndex(x=>x.id===currentLoad.id);
      const copy = JSON.parse(JSON.stringify(currentLoad));
      if(idx>=0) store.history[idx] = copy;
      else store.history.unshift(copy);
      store.history = store.history.slice(0, 150);
      saveStore(store);
      renderHistory();
    }

    function resetCurrentLoad(){
      currentLoad = {
        id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()),
        date: nowStamp(),
        tracking: "",
        items: []
      };
      $("trackingInput").value = "";
      $("dateInput").value = currentLoad.date;
      $("productInput").value = "";
      $("qtyInput").value = "";
      pendingPhoto = null;
      renderPendingPhoto();
      renderItems();
      setStatus("ok","Nueva carga lista. Inicia c√°mara y captura el tracking.");
    }

    /********************
     * Render
     ********************/
    function renderItems(){
      const list = $("itemsList");
      list.innerHTML = "";

      if(currentLoad.items.length===0){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "A√∫n no has agregado productos. (Info + Foto, en orden).";
        list.appendChild(empty);
      }else{
        currentLoad.items.forEach((it, idx)=>{
          const div = document.createElement("div");
          div.className = "item";

          const thumb = document.createElement("div");
          thumb.className = "thumb";
          if(it.photo){
            const img = document.createElement("img");
            img.src = it.photo;
            img.alt = `Foto ${idx+1}`;
            thumb.appendChild(img);
          }else{
            const p = document.createElement("div");
            p.className = "noimg";
            p.textContent = "Sin foto";
            thumb.appendChild(p);
          }

          const meta = document.createElement("div");
          meta.className = "meta";

          const top = document.createElement("div");
          top.className = "metaTop";

          const info = document.createElement("div");
          const strong = document.createElement("strong");
          strong.textContent = `${it.qty} / ${it.product}`;
          const small = document.createElement("small");
          small.textContent = `Orden: ${idx+1} ¬∑ Tracking: ${currentLoad.tracking || "(vac√≠o)"}`;
          info.appendChild(strong);
          info.appendChild(small);

          const mini = document.createElement("div");
          mini.className = "miniBtns";

          const btnDel = document.createElement("button");
          btnDel.className = "danger";
          btnDel.textContent = "Eliminar";
          btnDel.addEventListener("click", ()=>{
            currentLoad.items.splice(idx,1);
            persistCurrentToHistory();
            renderItems();
          });

          mini.appendChild(btnDel);
          top.appendChild(info);
          top.appendChild(mini);

          meta.appendChild(top);

          div.appendChild(thumb);
          div.appendChild(meta);

          list.appendChild(div);
        });
      }

      const totalUnits = currentLoad.items.reduce((a,b)=>a + (Number(b.qty)||0), 0);
      $("totalUnits").textContent = String(totalUnits);
      $("totalItems").textContent = String(currentLoad.items.length);
    }

    function renderHistory(){
      const wrap = $("historyList");
      wrap.innerHTML = "";

      if(store.history.length===0){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "No hay cargas guardadas a√∫n.";
        wrap.appendChild(empty);
        return;
      }

      store.history.forEach((h)=>{
        const box = document.createElement("div");
        box.className = "historyItem";

        const top = document.createElement("div");
        top.className = "top";

        const left = document.createElement("div");
        const st = document.createElement("strong");
        st.textContent = `Tracking: ${h.tracking || "(sin tracking)"}`;
        const sm = document.createElement("small");
        const units = h.items.reduce((a,b)=>a + (Number(b.qty)||0), 0);
        sm.textContent = `${h.date} ¬∑ ${h.items.length} productos ¬∑ ${units} unidades`;
        left.appendChild(st);
        left.appendChild(sm);

        const actions = document.createElement("div");
        actions.className = "actions";

        const btnLoad = document.createElement("button");
        btnLoad.className = "secondary";
        btnLoad.textContent = "Abrir";
        btnLoad.addEventListener("click", ()=>{
          currentLoad = JSON.parse(JSON.stringify(h));
          $("trackingInput").value = currentLoad.tracking || "";
          $("dateInput").value = currentLoad.date || nowStamp();
          pendingPhoto = null;
          renderPendingPhoto();
          renderItems();
          setStatus("ok","Carga cargada desde historial.");
        });

        const btnDel = document.createElement("button");
        btnDel.className = "danger";
        btnDel.textContent = "Eliminar";
        btnDel.addEventListener("click", ()=>{
          store.history = store.history.filter(x=>x.id!==h.id);
          saveStore(store);
          renderHistory();
          setStatus("ok","Carga eliminada del historial.");
        });

        actions.appendChild(btnLoad);
        actions.appendChild(btnDel);

        top.appendChild(left);
        top.appendChild(actions);

        box.appendChild(top);
        wrap.appendChild(box);
      });
    }

    /********************
     * C√°mara (1 stream para todo)
     ********************/
    let camStream = null;
    let camFacing = "environment";
    let detector = null;
    let scanningBarcode = false;
    let scanRaf = null;

    const roiCanvas = document.createElement("canvas");
    const roiCtx = roiCanvas.getContext("2d", { willReadFrequently: true });

    function supportsBarcodeDetector(){ return "BarcodeDetector" in window; }

    async function applyFocusIfPossible(stream){
      try{
        const track = stream.getVideoTracks()[0];
        if(!track?.getCapabilities) return;
        const caps = track.getCapabilities();
        if(caps.focusMode && caps.focusMode.includes?.("continuous")){
          await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
        }
        if(caps.exposureMode && caps.exposureMode.includes?.("continuous")){
          await track.applyConstraints({ advanced: [{ exposureMode: "continuous" }] });
        }
      }catch(e){}
    }

    function setupTorchButton(stream, btn){
      try{
        const track = stream.getVideoTracks()[0];
        if(!track?.getCapabilities){ btn.style.display="none"; return; }
        const caps = track.getCapabilities();
        if(!caps.torch){ btn.style.display="none"; return; }
        let torchOn = false;
        btn.style.display = "inline-flex";
        btn.textContent = "Linterna: OFF";
        btn.onclick = async ()=>{
          torchOn = !torchOn;
          try{
            await track.applyConstraints({ advanced: [{ torch: torchOn }] });
            btn.textContent = `Linterna: ${torchOn ? "ON" : "OFF"}`;
          }catch(e){
            torchOn = !torchOn;
          }
        };
      }catch(e){
        btn.style.display="none";
      }
    }

    async function setupZoomUI(stream){
      const wrap = $("zoomWrap");
      const range = $("zoomRange");
      try{
        const track = stream.getVideoTracks()[0];
        if(!track?.getCapabilities){ wrap.style.display="none"; return; }
        const caps = track.getCapabilities();
        if(!caps.zoom){ wrap.style.display="none"; return; }

        wrap.style.display="block";
        range.min = caps.zoom.min ?? 1;
        range.max = caps.zoom.max ?? 1;
        range.step = caps.zoom.step ?? 0.1;
        range.value = track.getSettings?.().zoom ?? range.min;

        range.oninput = async ()=>{
          const z = Number(range.value);
          try{ await track.applyConstraints({ advanced: [{ zoom: z }] }); }catch(e){}
        };
      }catch(e){
        $("zoomWrap").style.display="none";
      }
    }

    async function startCam(){
      if(camStream) return;

      try{
        if(supportsBarcodeDetector()){
          detector = new BarcodeDetector({
            formats: ["qr_code","code_128","code_39","ean_13","ean_8","upc_a","upc_e","itf","pdf417","aztec","data_matrix"]
          });
        } else {
          detector = null;
        }

        camStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: camFacing },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio:false
        });

        const v = $("video");
        v.srcObject = camStream;
        await v.play();

        await applyFocusIfPossible(camStream);
        setupTorchButton(camStream, $("btnTorch"));
        await setupZoomUI(camStream);

        $("btnStopCam").disabled = false;
        $("btnStartCam").disabled = true;
        $("btnBarcode").disabled = !detector;
        $("btnOcrView").disabled = false;

        setStatus("ok", detector
          ? "C√°mara lista. Puedes usar OCR o escanear QR/barra."
          : "C√°mara lista. Usa OCR (tu navegador no soporta BarcodeDetector)."
        );
      }catch(e){
        stopCam();
        setStatus("bad","No pude abrir la c√°mara. Revisa permisos o abre desde https.");
      }
    }

    function stopCam(){
      scanningBarcode = false;
      if(scanRaf){ cancelAnimationFrame(scanRaf); scanRaf = null; }

      const v = $("video");
      try{ v.pause(); }catch(e){}
      v.srcObject = null;

      if(camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream = null;
      }

      $("btnStopCam").disabled = true;
      $("btnStartCam").disabled = false;
      $("btnBarcode").disabled = true;
      $("btnOcrView").disabled = true;
      $("btnTorch").style.display = "none";
      $("zoomWrap").style.display = "none";

      setStatus("ok","C√°mara detenida.");
    }

    async function switchCam(){
      camFacing = (camFacing === "environment") ? "user" : "environment";
      if(camStream){
        stopCam();
        await startCam();
      } else {
        setStatus("ok", `C√°mara configurada a: ${camFacing}.`);
      }
    }

    function getRoiMode(){
      return $("chkTopRoi").checked ? "top" : "center";
    }

    function updateRoiUI(){
      const top = $("roiTop");
      const center = $("roiCenter");
      if(getRoiMode()==="top"){
        top.classList.add("show");
        center.style.opacity = "0";
      }else{
        top.classList.remove("show");
        center.style.opacity = "1";
      }
    }

    /********************
     * Barcode scan loop
     ********************/
    async function startBarcodeScan(){
      if(!camStream){
        setStatus("bad","Primero inicia la c√°mara.");
        return;
      }
      if(!detector){
        setStatus("bad","Tu navegador no soporta escaneo de c√≥digos. Usa OCR.");
        return;
      }
      scanningBarcode = true;
      setStatus("ok","Escaneando c√≥digo... Alinea QR/barra en el recuadro.");
      barcodeLoop();
    }

    function stopBarcodeScan(){
      scanningBarcode = false;
      if(scanRaf){ cancelAnimationFrame(scanRaf); scanRaf = null; }
    }

    async function barcodeLoop(){
      if(!scanningBarcode || !detector || !camStream) return;
      const v = $("video");
      if(v.readyState < 2){
        scanRaf = requestAnimationFrame(barcodeLoop);
        return;
      }

      const vw = v.videoWidth, vh = v.videoHeight;

      // ROI depende del modo
      let roiW, roiH, roiX, roiY;
      if(getRoiMode()==="top"){
        roiW = Math.floor(vw * 0.86);
        roiH = Math.floor(vh * 0.18);
        roiX = Math.floor((vw - roiW)/2);
        roiY = Math.floor(vh * 0.10);
      }else{
        roiW = Math.floor(vw * 0.78);
        roiH = Math.floor(vh * 0.22);
        roiX = Math.floor((vw - roiW)/2);
        roiY = Math.floor((vh - roiH)/2);
      }

      roiCanvas.width = roiW;
      roiCanvas.height = roiH;
      roiCtx.drawImage(v, roiX, roiY, roiW, roiH, 0, 0, roiW, roiH);

      try{
        const bitmap = await createImageBitmap(roiCanvas);
        const codes = await detector.detect(bitmap);
        bitmap.close?.();
        if(codes && codes.length){
          const t = sanitizeTracking(codes[0].rawValue || "");
          if(t){
            $("trackingInput").value = t;
            currentLoad.tracking = t;
            persistCurrentToHistory();
            renderItems();
            beep();
            setStatus("ok","‚úÖ Tracking capturado por QR/barra.");
            stopBarcodeScan();
            return;
          }
        }
      }catch(e){}

      scanRaf = requestAnimationFrame(barcodeLoop);
    }

    /********************
     * OCR INTELIGENTE
     * - acepta 8+ d√≠gitos
     * - prioridad: n√∫mero despu√©s de "Tracking"
     * - evita fechas (DDMMYYYY / MMDDYYYY / YYYYMMDD)
     ********************/
    const MIN_TRACK_DIGITS = 8;
    let ocrWorker = null;

    function normalizeOcrText(t){
      return String(t || "")
        .replace(/[Oo]/g, "0")
        .replace(/[Il|]/g, "1")
        .replace(/[Ss]/g, "5")
        .replace(/[Bb]/g, "8")
        .replace(/[Zz]/g, "2");
    }

    function joinSplitDigits(t){
      let s = t;
      for(let i=0;i<8;i++){
        s = s.replace(/(\d)\s+(\d)/g, "$1$2");
        s = s.replace(/(\d)\n(\d)/g, "$1$2");
      }
      return s;
    }

    function looksLikeDate8(d){
      const toInt = (x)=>Number(x);
      const dd = toInt(d.slice(0,2));
      const mm = toInt(d.slice(2,4));
      const yyyy = toInt(d.slice(4,8));

      const mm2 = toInt(d.slice(0,2));
      const dd2 = toInt(d.slice(2,4));
      const yyyy2 = toInt(d.slice(4,8));

      const yyyy3 = toInt(d.slice(0,4));
      const mm3 = toInt(d.slice(4,6));
      const dd3 = toInt(d.slice(6,8));

      const yearOk = (y)=> y >= 1990 && y <= 2099;

      if(dd>=1 && dd<=31 && mm>=1 && mm<=12 && yearOk(yyyy)) return true;     // DDMMYYYY
      if(mm2>=1 && mm2<=12 && dd2>=1 && dd2<=31 && yearOk(yyyy2)) return true; // MMDDYYYY
      if(yearOk(yyyy3) && mm3>=1 && mm3<=12 && dd3>=1 && dd3<=31) return true; // YYYYMMDD
      return false;
    }

    function scoreCandidateDigits(d){
      let score = d.length * 10;

      // castiga fecha t√≠pica
      if(d.length === 8 && looksLikeDate8(d)) score -= 90;

      // castiga si empieza con a√±o (YYYY...)
      if(d.length >= 8){
        const first4 = Number(d.slice(0,4));
        if(first4 >= 1990 && first4 <= 2099) score -= 25;
      }

      // bonifica longitudes mayores
      if(d.length >= 12) score += 15;
      if(d.length >= 20) score += 25;

      return score;
    }

    function extractBestTracking(rawText){
      let s = normalizeOcrText(rawText);
      s = joinSplitDigits(s);

      // 1) Prioridad: si aparece "Tracking", tomar el n√∫mero cerca
      const m = s.match(/tracking[^0-9]*([0-9]{6,})/i);
      if(m){
        const cand = m[1].replace(/\D/g,"");
        if(cand.length >= MIN_TRACK_DIGITS) return cand;
      }

      // 2) Si no hay "Tracking", elegir mejor por score
      const runs = (s.match(/\d+/g) || [])
        .map(x => x.replace(/\D/g,""))
        .filter(x => x.length >= MIN_TRACK_DIGITS);

      if(!runs.length) return null;

      let best = null;
      let bestScore = -Infinity;
      for(const d of runs){
        const sc = scoreCandidateDigits(d);
        if(sc > bestScore){
          bestScore = sc;
          best = d;
        }
      }

      // Si lo √∫nico que hay es fecha de 8 d√≠gitos -> no aceptes
      if(best && best.length === 8 && looksLikeDate8(best)) return null;

      return best;
    }

    async function getOcrWorker(){
      if(ocrWorker) return ocrWorker;

      ocrWorker = await Tesseract.createWorker({
        logger: m=>{
          if(m.status === "recognizing text"){
            setStatus("ok", `OCR leyendo... ${Math.round((m.progress||0)*100)}%`);
          }
        }
      });

      await ocrWorker.loadLanguage("eng");
      await ocrWorker.initialize("eng");

      // Permitimos letras que OCR confunde con n√∫meros; luego las convertimos
      await ocrWorker.setParameters({
        tessedit_char_whitelist: "0123456789OoIl|SsBbZz",
        preserve_interword_spaces: "1",
        user_defined_dpi: "300"
      });

      return ocrWorker;
    }

    function showOcrPreview(dataUrl, detected){
      $("ocrBox").classList.add("show");
      $("ocrImg").src = dataUrl;
      $("ocrDetected").textContent = detected || "‚Äî";
    }

    function hideOcrPreview(){
      $("ocrBox").classList.remove("show");
      $("ocrImg").src = "";
      $("ocrDetected").textContent = "‚Äî";
    }

    function snapshotRoiFromVideo(){
      const v = $("video");
      if(!v || v.readyState < 2) return null;

      const vw = v.videoWidth, vh = v.videoHeight;

      let roiW, roiH, roiX, roiY;
      if(getRoiMode()==="top"){
        roiW = Math.floor(vw * 0.86);
        roiH = Math.floor(vh * 0.18);
        roiX = Math.floor((vw - roiW)/2);
        roiY = Math.floor(vh * 0.10);
      }else{
        roiW = Math.floor(vw * 0.78);
        roiH = Math.floor(vh * 0.22);
        roiX = Math.floor((vw - roiW)/2);
        roiY = Math.floor((vh - roiH)/2);
      }

      const c = document.createElement("canvas");
      c.width = roiW;
      c.height = roiH;
      const ctx = c.getContext("2d", { willReadFrequently: true });
      ctx.drawImage(v, roiX, roiY, roiW, roiH, 0, 0, roiW, roiH);

      // Preprocesado fuerte: gris + contraste + umbral
      const img = ctx.getImageData(0,0,roiW,roiH);
      const d = img.data;

      let sum = 0;
      for(let i=0;i<d.length;i+=4){
        const gray = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114);
        sum += gray;
      }
      const avg = sum / (d.length/4);
      const thresh = avg * 0.92;

      for(let i=0;i<d.length;i+=4){
        let gray = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114);
        gray = (gray - avg) * 1.45 + avg;
        const v2 = (gray < thresh) ? 0 : 255;
        d[i]=d[i+1]=d[i+2]=v2;
        d[i+3]=255;
      }
      ctx.putImageData(img,0,0);

      return c.toDataURL("image/png");
    }

    async function runOcrOnDataUrl(dataUrl){
      hideOcrPreview();
      setStatus("ok","OCR iniciando...");
      try{
        const worker = await getOcrWorker();
        const res = await worker.recognize(dataUrl);
        const rawText = res?.data?.text || "";

        const best = extractBestTracking(rawText);
        showOcrPreview(dataUrl, best || "(no detectado)");

        if(best){
          $("trackingInput").value = best;
          currentLoad.tracking = best;
          persistCurrentToHistory();
          renderItems();
          beep();
          setStatus("ok", `‚úÖ Tracking capturado (${best.length} d√≠gitos).`);
        }else{
          setStatus("bad","OCR no encontr√≥ tracking v√°lido (solo fechas u otros n√∫meros). Activa ‚Äúfranja superior‚Äù y reintenta.");
        }
      }catch(e){
        setStatus("bad","Error OCR. Intenta con mejor luz o usa OCR desde foto.");
      }
    }

    async function ocrFromView(){
      if(!camStream){
        setStatus("bad","Primero inicia la c√°mara.");
        return;
      }
      stopBarcodeScan(); // evita competir
      const shot = snapshotRoiFromVideo();
      if(!shot){
        setStatus("bad","No pude capturar la vista. Intenta otra vez.");
        return;
      }
      await runOcrOnDataUrl(shot);
    }

    async function ocrFromImage(file){
      if(!file) return;
      setStatus("ok","Cargando imagen para OCR...");
      const reader = new FileReader();
      reader.onload = async ()=>{
        const dataUrl = reader.result;
        if(typeof dataUrl === "string"){
          await runOcrOnDataUrl(dataUrl);
        }
      };
      reader.readAsDataURL(file);
    }

    /********************
     * Producto: Foto (info + foto)
     ********************/
    let pendingPhoto = null;

    function renderPendingPhoto(){
      const wrap = $("pendingPhotoWrap");
      const img = $("pendingPhotoImg");
      const btnRemove = $("btnRemovePendingPhoto");
      if(pendingPhoto){
        wrap.style.display="block";
        img.src = pendingPhoto;
        btnRemove.disabled = false;
      }else{
        wrap.style.display="none";
        img.src = "";
        btnRemove.disabled = true;
      }
    }

    /********************
     * WhatsApp share
     ********************/
    function shareTextToWhatsApp(text){
      if(navigator.share){
        navigator.share({ text }).catch(()=>{});
        return;
      }
      const url = "https://wa.me/?text=" + encodeURIComponent(text);
      window.open(url, "_blank");
    }

    async function shareOrderedItems(load){
      if(!navigator.share){
        setStatus("bad","Tu navegador no soporta compartir. Usa el bot√≥n de WhatsApp (texto).");
        return;
      }
      const canFiles = !!navigator.canShare;

      for(let i=0;i<load.items.length;i++){
        const it = load.items[i];
        const line = `${i+1}) ${it.qty} / ${it.product}\nTracking: ${load.tracking || ""}`;

        if(it.photo && canFiles){
          try{
            const blob = await dataUrlToBlob(it.photo);
            const file = new File([blob], `producto_${i+1}.jpg`, {type: blob.type || "image/jpeg"});
            if(navigator.canShare({ files:[file] })){
              await navigator.share({ text: line, files:[file] });
              continue;
            }
          }catch(e){}
        }
        try{
          await navigator.share({ text: line + (it.photo ? "\nüñºÔ∏è (Adjunta la foto si no sali√≥)" : "") });
        }catch(e){
          setStatus("bad","Compartici√≥n cancelada.");
          return;
        }
      }
      setStatus("ok","Compartido en orden (seg√∫n soporte del dispositivo).");
    }

    /********************
     * Eventos UI
     ********************/
    $("dateInput").value = currentLoad.date;
    renderPendingPhoto();
    renderItems();
    renderHistory();
    setStatus("ok","Listo. Inicia c√°mara y usa OCR (recomendado).");

    $("chkTopRoi").addEventListener("change", ()=>{
      updateRoiUI();
      setStatus("ok", getRoiMode()==="top"
        ? "Modo franja superior activo (mejor para etiquetas con ‚ÄúTracking:‚Äù)."
        : "Modo centro activo."
      );
    });
    updateRoiUI();

    $("trackingInput").addEventListener("input",(e)=>{
      currentLoad.tracking = sanitizeTracking(e.target.value);
      persistCurrentToHistory();
      renderItems();
    });

    $("btnNewLoad").addEventListener("click", ()=>{
      persistCurrentToHistory();
      resetCurrentLoad();
    });

    $("btnClearAll").addEventListener("click", ()=>{
      if(!confirm("¬øSeguro que quieres borrar TODO el historial?")) return;
      store = {history:[]};
      saveStore(store);
      resetCurrentLoad();
      renderHistory();
      setStatus("ok","Historial borrado.");
    });

    $("btnStartCam").addEventListener("click", startCam);
    $("btnStopCam").addEventListener("click", stopCam);
    $("btnSwitchCam").addEventListener("click", switchCam);

    $("btnBarcode").addEventListener("click", startBarcodeScan);
    $("btnOcrView").addEventListener("click", ocrFromView);

    $("btnOcrImage").addEventListener("click", ()=> $("fileInputOcr").click());
    $("fileInputOcr").addEventListener("change",(e)=>{
      const f = e.target.files?.[0];
      e.target.value = "";
      ocrFromImage(f);
    });

    // Foto producto
    $("btnTakePhoto").addEventListener("click", ()=> $("fileInputPhotoCam").click());
    $("fileInputPhotoCam").addEventListener("change",(e)=>{
      const f = e.target.files?.[0];
      e.target.value = "";
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        if(typeof r.result === "string"){
          pendingPhoto = r.result;
          renderPendingPhoto();
          setStatus("ok","Foto lista para guardarse con el producto.");
        }
      };
      r.readAsDataURL(f);
    });

    $("btnUploadPhoto").addEventListener("click", ()=> $("fileInputPhoto").click());
    $("fileInputPhoto").addEventListener("change",(e)=>{
      const f = e.target.files?.[0];
      e.target.value = "";
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        if(typeof r.result === "string"){
          pendingPhoto = r.result;
          renderPendingPhoto();
          setStatus("ok","Foto lista para guardarse con el producto.");
        }
      };
      r.readAsDataURL(f);
    });

    $("btnRemovePendingPhoto").addEventListener("click", ()=>{
      pendingPhoto = null;
      renderPendingPhoto();
      setStatus("ok","Foto pendiente removida.");
    });

    $("btnAddItem").addEventListener("click", ()=>{
      const product = $("productInput").value.trim();
      const qty = Number($("qtyInput").value);

      if(!currentLoad.tracking){
        setStatus("bad","Primero captura/escribe el tracking (OCR o esc√°ner).");
        return;
      }
      if(!product){
        setStatus("bad","Escribe el nombre del producto.");
        return;
      }
      if(!qty || qty < 1){
        setStatus("bad","Ingresa una cantidad v√°lida (>= 1).");
        return;
      }
      if(!pendingPhoto){
        setStatus("bad","Falta la foto. (Info y foto, en orden.)");
        return;
      }

      currentLoad.items.push({ product, qty: Math.floor(qty), photo: pendingPhoto });

      $("productInput").value = "";
      $("qtyInput").value = "";
      pendingPhoto = null;
      renderPendingPhoto();

      persistCurrentToHistory();
      renderItems();
      setStatus("ok","Producto agregado ‚úÖ (info + foto en orden)");
    });

    $("btnSendWhatsApp").addEventListener("click", ()=>{
      if(!currentLoad.tracking || currentLoad.items.length===0){
        setStatus("bad","Carga vac√≠a. Captura tracking y agrega productos.");
        return;
      }
      persistCurrentToHistory();
      shareTextToWhatsApp(formatWhatsAppText(currentLoad));
    });

    $("btnShareOrdered").addEventListener("click", ()=>{
      if(!currentLoad.tracking || currentLoad.items.length===0){
        setStatus("bad","Carga vac√≠a. Captura tracking y agrega productos.");
        return;
      }
      persistCurrentToHistory();
      shareOrderedItems(currentLoad);
    });

    $("btnExportJson").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(store, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "historial_cargas.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 800);
      setStatus("ok","Historial exportado a JSON.");
    });

    // Al cerrar / cambiar pesta√±a: apaga c√°mara para no dejarla ‚Äúpegada‚Äù
    window.addEventListener("pagehide", ()=>{ try{ stopCam(); }catch(e){} });
  </script>
</body>
</html>
